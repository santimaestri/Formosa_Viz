<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Index — Visualizaciones Formosa (D3)</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <style>
    :root{
      --clarin-red:#E10000;
      --ink:#111827; --ink-inv:#ffffff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;
      color:var(--ink-inv);
      background:#000;
      background-image:url('https://www.clarin.com/img/2025/07/23/ppysLASu9_1256x620__1.jpg');
      background-size:cover; background-position:center; background-repeat:no-repeat;
    }
    .backdrop{position:fixed; inset:0; background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.75));}
    .wrap{position:relative; max-width:1100px; margin:32px auto; padding:20px}
    header{margin-bottom:18px}
    h1{margin:0 0 6px; font-size:28px; font-weight:800; letter-spacing:.2px}
    .sub{opacity:.9; margin:0 0 16px}
    .grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:14px}
    .card{position:relative; border-radius:16px; padding:16px 16px 14px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); color:#fff; text-decoration:none; overflow:hidden}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .card h3{margin:0 0 6px; font-size:18px}
    .card p{margin:0; opacity:.9}
    .badge{display:inline-block; font-size:12px; font-weight:700; padding:4px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.35); margin-bottom:10px}
    .cta{display:inline-flex; align-items:center; gap:8px; margin-top:10px; font-weight:700; color:#fff}
    .cta svg{width:18px; height:18px}
    .footer{margin-top:22px; font-size:12px; opacity:.8; display:flex; gap:12px; align-items:center}
    .clarin{color:var(--clarin-red)}
    #u-line{display:block; height:4px; border-radius:999px; background:rgba(255,255,255,.35)}
    details.tests{margin-top:18px}
    .pass{color:#22c55e}
    .fail{color:#ef4444}
    .gate-backdrop{position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,.68); backdrop-filter: blur(4px); z-index:9999;}
    .gate{width:min(92vw,420px); border-radius:18px; padding:22px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); color:#fff; box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .gate h2{margin:0 0 6px; font-size:22px}
    .gate p{margin:0 0 16px; opacity:.9}
    .row{display:flex; flex-direction:column; gap:8px; margin:10px 0}
    label{font-size:13px; opacity:.9}
    input[type="text"], input[type="password"]{width:100%; padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.08); color:#fff; outline:none;}
    .btn{display:inline-flex; gap:8px; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; border:1px solid rgba(255,255,255,.25); background:var(--clarin-red); color:#fff; width:100%;}
    .muted{opacity:.8; font-size:12px; margin-top:8px}
    .error{color:#ffb4b4; font-size:13px; min-height:1.2em}
    .hidden{display:none}
    .logout{cursor:pointer; border:1px solid rgba(255,255,255,.25); border-radius:10px; padding:6px 10px; font-weight:700}
  </style>
</head>
<body>
  <div class="backdrop"></div>
  <div class="wrap">
    <header>
      <h1>Narcotráfico en Formosa <span class="clarin">(D3)</span></h1>
      <p class="sub">Todo lo que necesitas saber, en datos y en imagen.</p>
      <div id="u-line"></div>
    </header>
    <main class="grid" id="links"></main>
    <details class="tests"><summary>Autotests</summary><ul id="test-list"></ul></details>
    <p class="footer">Abrí cada visual en una pestaña para cruzarlas.<span id="whoami" style="margin-left:auto; opacity:.85"></span><button id="logout" class="logout hidden" title="Cerrar sesión">Salir</button></p>
  </div>
  <div id="gate-root" class="hidden"></div>
  <script>
  (async function main(){
    if (!window.d3) { window.addEventListener('load', main, { once:true }); return; }
    const USERS = {
      // sha256("formosa2025")
      "santi": "577cdff578c53070dd214192c908a30334f61d0c262c9ab4f39d44f73be096d7"
    };
    const AUTH_NS = "viz_auth_formosa_v1";
    async function sha256Hex(text){
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function saveSession(user){ localStorage.setItem(AUTH_NS, JSON.stringify({user, t: Date.now()})); }
    function clearSession(){ localStorage.removeItem(AUTH_NS); location.reload(); }
    function getSession(){ try{ return JSON.parse(localStorage.getItem(AUTH_NS)||''); }catch{ return null; } }
    async function requireAuth(){
      const s = getSession();
      if (s && USERS[s.user]) { return s.user; }
      const root = document.getElementById('gate-root');
      root.className = 'gate-backdrop';
      root.innerHTML = `
        <div class="gate" role="dialog" aria-modal="true" aria-labelledby="gate-title">
          <h2 id="gate-title">Acceso a visualizaciones</h2>
          <p>Ingresá usuario y contraseña para ver los enlaces.</p>
          <div class="row"><label for="u">Usuario</label><input id="u" type="text" autocomplete="username" placeholder="tu usuario"></div>
          <div class="row"><label for="p">Contraseña</label><input id="p" type="password" autocomplete="current-password" placeholder="••••••••"></div>
          <div class="error" id="err"></div>
          <button id="go" class="btn">Ingresar</button>
          <p class="muted">Tip: podés cambiar usuarios/clave en el objeto <code>USERS</code>.</p>
        </div>
      `;
      const $u = root.querySelector('#u');
      const $p = root.querySelector('#p');
      const $go = root.querySelector('#go');
      const $err = root.querySelector('#err');
      async function tryLogin(){
        const user = ($u.value||'').trim();
        const pass = $p.value||'';
        if (!USERS[user]) { $err.textContent='Usuario o contraseña inválidos.'; return; }
        const ok = await sha256Hex(pass) === USERS[user];
        if (!ok){ $err.textContent='Usuario o contraseña inválidos.'; return; }
        saveSession(user);
        root.remove();
        return user;
      }
      $go.addEventListener('click', tryLogin);
      $p.addEventListener('keydown', e=>{ if(e.key==='Enter') tryLogin(); });
      $u.addEventListener('keydown', e=>{ if(e.key==='Enter') $p.focus(); });
      $u.focus();
      return new Promise(resolve=>{
        const i = setInterval(()=>{
          const s2 = getSession();
          if (s2 && USERS[s2.user]) { clearInterval(i); resolve(s2.user); }
        }, 100);
      });
    }
    const user = await requireAuth();
    const who = document.getElementById('whoami');
    const logout = document.getElementById('logout');
    if (user){ who.textContent = `Conectado: ${user}`; logout.classList.remove('hidden'); }
    logout.addEventListener('click', clearSession);
    const items = [
      { title: 'Mapa — Drogas incautadas', file: 'drogas_incautadas_clorinda.html', blurb: 'Con desglose por sustancia y hallazgo.' },
      { title: 'Mapa — Fuerzas & Incautaciones', file: 'mapa_fuerzas_incautaciones.html', blurb: 'Dónde, qué fuerza intervino y lo que incautó.' },
      { title: 'Videoteca — Narcotráfico y poder en Formosa', file: 'videoteca_estilo_clarin_narcotrafico_y_poder_en_formosa_html.html', blurb: 'Tres videos periodísticos contundentes sobre narcotráfico y poder en Formosa.' },
      { title: 'Wordcloud — Análisis de palabras', file: 'clarin_wordcloud', blurb: 'Palabras más mencionadas de los entrevistados.' },      
      { title: 'Infografía — Detenidos', file: 'visualizacion_aprehendidos_d_3_formosa.html', blurb: 'Gráfico con evolución entre 2015 a 2024.' },
      { title: 'Infografía — Cocaína', file: 'visualizacion_cocaina_d_3_formosa.html', blurb: 'Incautaciones: tendencia y variación interanual.' },
      { title: 'Infografía — Marihuana', file: 'visualizacion_marihuana_d_3_formosa.html', blurb: 'Incautaciones: evolución y picos relevantes.' },
      { title: 'Investigaciones — Notas', file: 'notas_relacionadas.html', blurb: 'Artículos recientes de medios e instituciones extranjeras.' },
      { title: 'Database — Poder Judicial Formosa (API)', file: 'buscador_de_fallos', blurb: 'Buscá las causas contra Insfrán o los poderosos de Formosa.' }    
    ];
    const BASE = 'https://santimaestri.github.io/Formosa_Viz/';
    const sel = d3.select('#links').selectAll('a.card').data(items).enter().append('a').attr('class','card').attr('href', d => `${BASE}${d.file}`).attr('target', '_blank').attr('rel','noopener');
    sel.append('span').attr('class','badge').text('HTML • D3');
    sel.append('h3').text(d => d.title);
    sel.append('p').text(d => d.blurb);
    sel.append('span').attr('class','cta').html(`Abrir<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`);
    const u = d3.select('#u-line');
    function animateUnderline(){
      u.style('background', 'rgba(255,255,255,.2)');
      const dur = 900;
      d3.select('#u-line').transition().duration(dur).style('background', '#E10000').transition().duration(600).style('background', 'rgba(255,255,255,.35)');
    }
    document.addEventListener('visibilitychange', () => { if (!document.hidden) animateUnderline(); });
    animateUnderline();
    (function tests(){
      const out=[]; const ok=(name)=>out.push({name,ok:true}); const ko=(name,msg)=>out.push({name,ok:false,msg});
      try{ if(window.d3) ok('d3 cargó'); else ko('d3 cargó','d3 no está definido'); }catch(e){ ko('d3 cargó', e.message); }
      try{ const n = document.querySelectorAll('a.card').length; if(n===items.length) ok('Se renderizaron todas las tarjetas'); else ko('Render tarjetas', `esperado ${items.length}, got ${n}`);}catch(e){ ko('Render tarjetas', e.message); }
      try{ const allBlank = [...document.querySelectorAll('a.card')].every(a=>a.getAttribute('target')==='_blank'); if(allBlank) ok('Links abren en nueva pestaña'); else ko('Target _blank','faltan target'); }catch(e){ ko('Target _blank', e.message); }
      const ul=document.getElementById('test-list'); out.forEach(t=>{ const li=document.createElement('li'); li.textContent=(t.ok?'✓ ':'✗ ')+t.name+(t.ok?'':` — ${t.msg||''}`); li.className=t.ok?'pass':'fail'; ul.appendChild(li); });
    })();
  })();
  </script>
</body>
</html>
