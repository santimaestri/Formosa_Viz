<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aprehendidos por narcotráfico — Formosa (2015–2024)</title>
  <script src="https://cdn.jsdelivr.net/npm/d3@7" defer></script>
  <style>
    :root{
      --clarin-red:#E10000;
      --bg:#ffffff; --card:#fafafa; --ink:#222222; --muted:#6b7280;
      --series-a: var(--clarin-red);
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    .card{background:linear-gradient(180deg,var(--card),#f1f1f1 120%);border:1px solid #e6e6e6;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:18px 18px 8px}
    h1{font-size:20px;margin:0 0 6px}
    .sub{color:var(--muted);margin-bottom:16px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .btn{background:#ffffff;border:1px solid var(--clarin-red);color:var(--clarin-red);border-radius:10px;padding:8px 10px;cursor:pointer;font-weight:600}
    .btn:hover{background:var(--clarin-red);color:#ffffff}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    svg{width:100%;height:auto;display:block}
    .grid line{stroke:#e5e7eb}
    .axis text{fill:#374151}
    .axis path, .axis line{stroke:#e5e7eb}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Aprehendidos por narcotráfico — Fuerzas Federales</h1>
    <div class="sub">Serie anual 2015–2024. Al presionar <b>“Ver evolución”</b>, aparecen <b>barras</b> que crecen desde el eje X mostrando su valor.</div>
    <svg id="chart" viewBox="0 0 1000 620" preserveAspectRatio="none"></svg>
    <div class="controls">
      <button class="btn" id="play">Ver evolución</button>
      <button class="btn" id="reset">Reset</button>
    </div>
  </div>
</div>
<script>
function resolveCssColor(varName, fallback){
  try{
    let val = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    let guard=0;
    while(val && val.startsWith('var(') && guard<5){
      const m=val.match(/var\((--[^),\s]+)/);
      if(!m) break;
      val=getComputedStyle(document.documentElement).getPropertyValue(m[1]).trim();
      guard++;
    }
    return val || fallback;
  }catch(e){return fallback;}
}

function initViz(){
  const data = [
    {year:2015, value:151},
    {year:2016, value:156},
    {year:2017, value:204},
    {year:2018, value:205},
    {year:2019, value:229},
    {year:2020, value:191},
    {year:2021, value:178},
    {year:2022, value:209},
    {year:2023, value:250},
    {year:2024, value:178}
  ];

  const COLOR_BAR = resolveCssColor('--series-a', '#E10000');

  const svg = d3.select('#chart');
  const W=1000,H=620,m={top:24,right:24,bottom:60,left:80};
  const innerW=W-m.left-m.right, innerH=H-m.top-m.bottom;
  const g = svg.append('g').attr('transform',`translate(${m.left},${m.top})`);

  // Escalas y ejes
  const x = d3.scaleBand().domain(data.map(d=>d.year)).range([0,innerW]).padding(0.18);
  const y = d3.scaleLinear().domain([0, d3.max(data,d=>d.value)*1.15]).nice().range([innerH,0]);
  g.append('g').attr('class','axis').attr('transform',`translate(0,${innerH})`).call(d3.axisBottom(x).tickFormat(d3.format('d')));
  g.append('g').attr('class','axis').call(d3.axisLeft(y));
  g.append('g').attr('class','grid').call(d3.axisLeft(y).tickSize(-innerW).tickFormat(''));

  // Barras y etiquetas
  const bars = g.selectAll('.bar').data(data).enter().append('rect')
    .attr('class','bar')
    .attr('x',d=>x(d.year))
    .attr('width',x.bandwidth())
    .attr('y',y(0))
    .attr('height',0)
    .attr('rx',4)
    .attr('fill',COLOR_BAR)
    .attr('opacity',0);

  const labels = g.selectAll('.label').data(data).enter().append('text')
    .attr('class','label')
    .attr('x',d=>x(d.year)+x.bandwidth()/2)
    .attr('y',y(0)-5)
    .attr('text-anchor','middle')
    .attr('fill','#111')
    .attr('font-size','12px')
    .attr('font-weight','bold')
    .attr('opacity',0)
    .text(d=>d.value);

  // Botones
  const play = document.getElementById('play');
  const reset = document.getElementById('reset');

  function run(){
    play.disabled=true; play.textContent='Reproduciendo...';
    bars.interrupt().attr('y',y(0)).attr('height',0).attr('opacity',0);
    labels.interrupt().attr('y',y(0)-5).attr('opacity',0);

    data.forEach((d,i)=>{
      bars.filter(b=>b.year===d.year)
        .transition().duration(520).delay(i*160).ease(d3.easeCubicOut)
        .attr('opacity',1)
        .attr('y',y(d.value))
        .attr('height',y(0)-y(d.value));

      labels.filter(b=>b.year===d.year)
        .transition().duration(520).delay(i*160)
        .attr('opacity',1)
        .attr('y',y(d.value)-5);
    });

    const totalDelay = (data.length-1)*160 + 520;
    setTimeout(()=>{ play.disabled=false; play.textContent='Repetir evolución'; }, totalDelay+50);
  }

  function resetAll(){
    bars.interrupt().attr('y',y(0)).attr('height',0).attr('opacity',0);
    labels.interrupt().attr('y',y(0)-5).attr('opacity',0);
    play.disabled=false; play.textContent='Ver evolución';
  }

  play.addEventListener('click', run);
  reset.addEventListener('click', resetAll);
}

if(document.readyState!=='loading') initViz();
else document.addEventListener('DOMContentLoaded',initViz);
</script>
</body>
</html>
